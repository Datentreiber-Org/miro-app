<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Datentreiber – Template Mapper</title>
  <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 12px;
      font-size: 13px;
    }
    h3 {
      margin-top: 0;
      font-size: 15px;
    }
    h4 {
      margin: 8px 0 4px;
      font-size: 13px;
    }
    .block {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 12px;
      margin-right: 6px;
      margin-top: 4px;
    }
    button:hover {
      background: #eee;
    }
    label {
      display: block;
      margin: 4px 0;
    }
    input[type="password"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      margin-top: 2px;
      padding: 4px;
    }
    textarea {
      resize: vertical;
    }
    .hint {
      color: #666;
      font-size: 11px;
      margin: 0 0 4px;
    }
    #log {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 6px;
      max-height: 260px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <div id="app">
    <h3>Datentreiber – Template Mapper</h3>

    <div class="block">
      <h4>1) Template wählen</h4>
      <p class="hint">
        Auf dem Board das 3-Boxes-PNG auswählen (nur das Bild, nicht den Frame)
        und dann „Auswahl als Template setzen“ klicken.
      </p>
      <button id="btn-set-template">Auswahl als Template setzen</button>
      <button id="btn-classify">Stickies klassifizieren</button>
    </div>

    <div class="block">
      <h4>2) GPT-Abfrage</h4>
      <label>
        OpenAI API Key:
        <input id="api-key" type="password" placeholder="sk-..." autocomplete="off">
      </label>
      <label>
        Modell:
        <select id="model">
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="o3-mini">o3-mini</option>
        </select>
      </label>
      <label>
        Frage / Aufgabe an GPT:
        <textarea id="user-text" rows="3"
          placeholder="Bitte analysiere die Sticky Notes auf dem 3-Boxes-Canvas ..."></textarea>
      </label>
      <button id="btn-call-openai">
        An GPT senden (inkl. aktueller Klassifikation)
      </button>
    </div>

    <div class="block">
      <h4>Debug / Ausgabe</h4>
      <pre id="log"></pre>
    </div>
  </div>

  <script>
    // Fester Template-Typen-Name (kannst du später anpassen/erweitern)
    const TEMPLATE_ID = "datentreiber-3boxes";

    // Aktuelles Template (nur ein Bild)
    let currentTemplateImage = null;
    let lastClassification = null;

    function log(msg) {
      const el = document.getElementById("log");
      const text = typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
      el.textContent = (el.textContent ? el.textContent + "\n\n" : "") + text;
    }

    function stripHtml(html) {
      if (!html) return "";
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    async function setTemplateFromSelection() {
      log("Template aus aktueller Auswahl setzen ...");

      const selection = await miro.board.getSelection();
      if (!selection.length) {
        log("Kein Element ausgewählt. Bitte das Template-Bild auswählen und erneut versuchen.");
        return;
      }

      const image = selection.find((item) => item.type === "image");
      if (!image) {
        log("In der Auswahl ist kein Bild-Element. Bitte direkt das Template-PNG auswählen (nicht den Frame).");
        return;
      }

      currentTemplateImage = {
        id: image.id,
        title: image.title || "Datentreiber 3-Boxes",
        x: image.x,
        y: image.y,
        width: image.width,
        height: image.height,
      };

      log("Template gesetzt: Bild " + image.id + " (" + currentTemplateImage.title + ")");
    }

    // Hilfsfunktion: ordnet normalisierte Koordinate (px, py) einer Spalte zu.
    function mapToRegion(px, py) {
      // Vertikaler Bereich, in dem die drei großen Boxen liegen (grobe Werte)
      const yMin = 0.20;
      const yMax = 0.95;
      if (py < yMin || py > yMax) {
        return null;
      }

      if (px < 0 || px > 1) {
        return null;
      }

      const third = 1 / 3;
      if (px < third) {
        return { id: "left", title: "Box 1 (links)" };
      } else if (px < 2 * third) {
        return { id: "middle", title: "Box 2 (Mitte)" };
      } else {
        return { id: "right", title: "Box 3 (rechts)" };
      }
    }

    async function classifyStickies() {
      if (!currentTemplateImage) {
        log("Kein Template gesetzt. Bitte zuerst „Auswahl als Template setzen“ verwenden.");
        return;
      }

      const t = currentTemplateImage;
      const left = t.x - t.width / 2;
      const top = t.y - t.height / 2;

      const stickies = await miro.board.get({ type: "sticky_note" });

      const result = {
        template: {
          id: TEMPLATE_ID,
          name: t.title,
          imageId: t.id,
        },
        counts: {
          total: 0,
          byRegion: {},
        },
        items: [],
      };

      for (const s of stickies) {
        const sx = s.x;
        const sy = s.y;

        const px = (sx - left) / t.width;
        const py = (sy - top) / t.height;
        const inImageRect = px >= 0 && px <= 1 && py >= 0 && py <= 1;

        let regionId = null;
        let regionTitle = null;
        if (inImageRect) {
          const region = mapToRegion(px, py);
          if (region) {
            regionId = region.id;
            regionTitle = region.title;
          }
        }

        // Nur Sticky Notes, deren Zentrum innerhalb des Bild-Rechtecks liegt
        if (!inImageRect) {
          continue;
        }

        result.counts.total += 1;
        if (regionId) {
          result.counts.byRegion[regionId] =
            (result.counts.byRegion[regionId] || 0) + 1;
        }

        result.items.push({
          stickyId: s.id,
          text: stripHtml(s.content),
          px: Math.round(px * 10000) / 10000,
          py: Math.round(py * 10000) / 10000,
          inImageRect,
          regionId,
          regionTitle,
        });
      }

      lastClassification = result;
      log("Klassifikation fertig:");
      log(result);
    }

    async function callOpenAI() {
      const apiKey = document.getElementById("api-key").value.trim();
      const model = document.getElementById("model").value;
      const userText = document.getElementById("user-text").value.trim();

      if (!apiKey) {
        log("Bitte einen OpenAI API Key eingeben.");
        return;
      }
      if (!userText) {
        log("Bitte eine Frage / Aufgabe im Textfeld eingeben.");
        return;
      }

      const classificationPart = lastClassification
        ? "\n\nAktuelle Sticky-Notiz-Klassifikation (JSON):\n"
          + JSON.stringify(lastClassification, null, 2)
        : "";

      const fullUserText = userText + classificationPart;

      const body = {
        model,
        input: [
          {
            role: "system",
            content: [
              {
                type: "input_text",
                text:
                  "Du bist ein Assistent, der Miro-Boards analysiert. " +
                  "Du bekommst Sticky-Notes als JSON und eine Nutzerfrage " +
                  "und sollst prägnante Antworten liefern. " +
                  "Antworte standardmäßig auf Deutsch.",
              },
            ],
          },
          {
            role: "user",
            content: [
              {
                type: "input_text",
                text: fullUserText,
              },
            ],
          },
        ],
        max_output_tokens: 512,
      };

      try {
        log("Sende Anfrage an OpenAI ...");
        const res = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + apiKey,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });

        const text = await res.text();
        if (!res.ok) {
          log("Fehler bei OpenAI-Anfrage: " + res.status + " " + text);
          return;
        }

        const data = JSON.parse(text);
        const firstMessage = data.output && data.output[0];
        const contentArr = firstMessage && firstMessage.content;
        const textPart = contentArr && contentArr.find((c) => c.type === "output_text");
        const answer = textPart ? textPart.text : "(keine Antwort gefunden)";

        log("Antwort von OpenAI:");
        log(answer);
      } catch (err) {
        log("Exception beim Aufruf der OpenAI API: " + err.message);
      }
    }

    // Wiring erst, wenn Miro-SDK wirklich verbunden ist
    miro.onReady(() => {
      document.getElementById("btn-set-template").onclick = setTemplateFromSelection;
      document.getElementById("btn-classify").onclick = classifyStickies;
      document.getElementById("btn-call-openai").onclick = callOpenAI;

      log("Datentreiber – Template Mapper geladen. " +
          "1) Template-Bild auswählen, 2) „Auswahl als Template setzen“, 3) Stickies klassifizieren.");
    });
  </script>
</body>
</html>
